# End-to-End Guide: Log & Trace Monitoring with Grafana, Loki, Promtail, and Tempo

This guide provides a complete walkthrough of setting up and using a robust observability stack often referred to as the **PLGT** stack (Promtail, Loki, Grafana, Tempo).

## 1. Overview

We are using a microservices-inspired architecture where:
*   **Logs** are generated by applications, collected by **Promtail**, stored in **Loki**, and visualized in **Grafana**.
*   **Traces** are (conceptually) generated by applications, sent to **Tempo**, and visualized in **Grafana**.

### The Stack

| Component | Role | Description |
| :--- | :--- | :--- |
| **Grafana** | Visualization | The dashboard and query interface for all data. |
| **Loki** | Logs Aggregation | "Like Prometheus, but for logs." Stores log streams efficiently. |
| **Promtail** | Log Collector | Tails log files and pushes them to Loki. |
| **Tempo** | Distributed Tracing | High-volume, minimal-dependency trace storage. |
| **Go App** | Data Generator | Custom application simulating a microservices environment. |

## 2. Prerequisites

*   **Docker** and **Docker Compose** installed on your machine.
*   Basic understanding of command-line operations.

## 3. Architecture

```mermaid
graph LR
    subgraph "Application"
        App[Go Application] -->|Writes Logs| Files[/var/log/*]
        App -.->|sends traces (future)| Tempo
    end

    subgraph "Collection"
        Promtail -->|Tails| Files
        Promtail -->|Pushes| Loki
    end

    subgraph "Storage & Backend"
        Loki[Loki (Logs)]
        Tempo[Tempo (Traces)]
    end

    subgraph "Visualization"
        Grafana -->|Queries| Loki
        Grafana -->|Queries| Tempo
    end
```

## 4. Setup Guide

### 4.1. Start the Stack

Run the following command in the root of the repository:

```bash
docker-compose up -d
```

This will start:
1.  `log-generator`: The Go app writing logs.
2.  `loki`: The log store.
3.  `promtail`: The log shipper.
4.  `tempo`: The trace store.
5.  `grafana`: The visualization UI.

### 4.2. Verify Services

Check that all containers are running:

```bash
docker-compose ps
```

You should see all services with status `Up`.

## 5. detailed Walkthrough

### 5.1. Logs (Loki & Promtail)

**How it works:**
1.  The Go application writes logs to folders like `./logs/backend`, `./logs/frontend`, etc.
2.  **Promtail** (running as a container) has these folders mounted. It watches ("tails") the files defined in `promtail/promtail.yaml`.
3.  When a new log line appears, Promtail attaches labels (e.g., `job=backend`) and pushes it to **Loki** on port `3100`.

**How to View Logs in Grafana:**
1.  Open your browser to `http://localhost:3000`.
2.  Navigate to **Explore** (the compass icon in the sidebar).
3.  Ensure the datasource is set to **Loki**.
4.  Use the **Label Browser** to select:
    *   `job` = `backend` (or any other service)
5.  Click **Run Query**. You will see the live logs from your application.

### 5.2. Distributed Tracing (Tempo)

**How it works:**
*   **Tempo** is configured to listen for traces on standard OTLP ports (`4317` gRPC, `4318` HTTP).
*   Applications instrumented with OpenTelemetry SDKs send trace data to these ports.
*   Tempo stores these traces by ID.

**Note on Current Setup:**
The current `log-generator` application is a simple log writer. To start sending traces, you would typically add OpenTelemetry instrumentation to your code.

**Example Code Snippet (How you WOULD instrument Go):**

```go
// This is an example of what needs to be added to the Go app to send traces
import (
    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "go.opentelemetry.io/otel/sdk/trace"
)

func initTracer() {
    exporter, _ := otlptracegrpc.New(ctx, otlptracegrpc.WithEndpoint("tempo:4317"))
    tp := trace.NewTracerProvider(trace.WithBatcher(exporter))
    otel.SetTracerProvider(tp)
}
```

**How to View Traces in Grafana:**
1.  Go to **Explore**.
2.  Select **Tempo** as the data source (you may need to add it first if not auto-provisioned).
3.  If you have a Trace ID (e.g., from a log that includes it), paste it into the query field.
4.  You will see a Gantt chart visualization of the request lifetime.

## 6. Configuring Data Sources (If needed)

If you log in to Grafana and don't see Loki or Tempo:

1.  Go to **Connections** -> **Data Sources**.
2.  **Add new data source**.
3.  **Loki**:
    *   URL: `http://loki:3100`
    *   Click **Save & Test**.
4.  **Tempo**:
    *   URL: `http://tempo:3200`
    *   Click **Save & Test**.

## 7. Troubleshooting

*   **No logs?** Check permissions on the `./logs` directory. Promtail needs read access.
*   **Containers exiting?** Run `docker-compose logs <service_name>` to see why.
*   **Grafana not loading?** Give it a minute to start up; it listens on port 3000.
